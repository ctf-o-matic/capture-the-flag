#!/usr/bin/env bash
#
# Trigger an upgrade from this repository on a push.
# Install with ./setup.sh
#

set -euo pipefail

# the post-receive hook receives parameters on stdin
while read oldrev newrev refname; do
    branch=$(git rev-parse --symbolic --abbrev-ref "$refname")
    upgrade_sh=./upgrade.sh
    if [[ -f "$upgrade_sh" ]]; then
        upgrade_sh=$(readlink "$upgrade_sh" || echo "$upgrade_sh")
        echo "calling upgrade script: $upgrade_sh $branch"
        "$upgrade_sh" "$branch"
    else
        echo "NOT calling non-existent upgrade script: $upgrade_sh"
    fi
done
